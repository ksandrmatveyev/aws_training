{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS Task2",
  "Resources": {
        "myVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
				"EnableDnsSupport" : "true",
				"EnableDnsHostnames" : "true",
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    }
                ]
            }
        },
		
        "PublicSubnet01": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": "10.0.0.0/24",
                "AvailabilityZone": "us-east-1a",
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    },
                    {
                        "Key": "Network",
                        "Value": "Public"
                    }
                ]
            }
        },
		"InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    }
                ]
            }
        },
		
        "AttachInternetGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
		
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackId"
                        }
                    },
                    {
                        "Key": "Network",
                        "Value": "Public"
                    }
                ]
            }
        },
		
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachInternetGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
		
        "PublicSubnetRouteTableAssociation01": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet01"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
  
    "PublicSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "public Security Group",
		"VpcId": {
	      "Ref": "myVPC"
	    },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "4505",
            "ToPort": "4505",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "4506",
            "ToPort": "4506",
            "CidrIp": "0.0.0.0/0"
          }],
		  "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "4505",
            "ToPort": "4505",
            "CidrIp": "0.0.0.0/0"
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": "4506",
            "ToPort": "4506",
            "CidrIp": "0.0.0.0/0"
          }

        ]
      }
    },
    "SaltMaster": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": ["PublicSG","SaltMinion01","SaltMinion02"],
      "Properties": {
        "ImageId": "ami-49c9295f",
        "KeyName": "awskeytest",
        "InstanceType": "t2.micro",
        "NetworkInterfaces" : [{
          "GroupSet"                 : [{ "Ref" : "PublicSG" }],
          "AssociatePublicIpAddress" : "true",
          "DeviceIndex"              : "0",
          "DeleteOnTermination"      : "true",
          "SubnetId"                 : { "Ref" : "PublicSubnet01" },
		  "PrivateIpAddress" : "10.0.0.10"
        }],
        "Tags": [
          {
            "Key": "Name",
            "Value": "saltmaster"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "\n",
                "wget -O - https://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest/SALTSTACK-GPG-KEY.pub | apt-key add -\n",
				"echo 'deb http://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest trusty main' > /etc/apt/sources.list.d/saltstack.list\n",
				"apt-get update -y\n",
				"apt-get install salt-master -y\n",
				"yes | salt-key --accept-all\n"
              ]
            ]
          }
        }
      }
    },
    "SaltMinion01": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": "PublicSG",
      "Properties": {
        "ImageId": "ami-49c9295f",
        "KeyName": "awskeytest",
        "InstanceType": "t2.micro",
        "NetworkInterfaces" : [{
          "GroupSet"                 : [{ "Ref" : "PublicSG" }],
          "AssociatePublicIpAddress" : "true",
          "DeviceIndex"              : "0",
          "DeleteOnTermination"      : "true",
          "SubnetId"                 : { "Ref" : "PublicSubnet01" },
		  "PrivateIpAddress" : "10.0.0.11"
        }],
        "Tags": [
          {
            "Key": "Name",
            "Value": "saltminion01"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "\n",
                "wget -O - https://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest/SALTSTACK-GPG-KEY.pub | apt-key add -\n",
				"echo 'deb http://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest trusty main' > /etc/apt/sources.list.d/saltstack.list\n",
				"apt-get update -y\n",
				"apt-get install salt-minion -y\n",
				"sed -i 's/#master: salt/master: 10.0.0.10/' /etc/salt/minion\n",
				"service salt-minion restart\n"
              ]
            ]
          }
        }
      }
    },
	"SaltMinion02": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": "PublicSG",
      "Properties": {
        "ImageId": "ami-49c9295f",
        "KeyName": "awskeytest",
        "InstanceType": "t2.micro",
        "NetworkInterfaces" : [{
          "GroupSet"                 : [{ "Ref" : "PublicSG" }],
          "AssociatePublicIpAddress" : "true",
          "DeviceIndex"              : "0",
          "DeleteOnTermination"      : "true",
          "SubnetId"                 : { "Ref" : "PublicSubnet01" },
		  "PrivateIpAddress" : "10.0.0.12"
        }],
        "Tags": [
          {
            "Key": "Name",
            "Value": "saltminion02"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "\n",
                "wget -O - https://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest/SALTSTACK-GPG-KEY.pub | apt-key add -\n",
				"echo 'deb http://repo.saltstack.com/apt/ubuntu/14.04/amd64/latest trusty main' > /etc/apt/sources.list.d/saltstack.list\n",
				"apt-get update -y\n",
				"apt-get install salt-minion -y\n",
				"sed -i 's/#master: salt/master: 10.0.0.10/' /etc/salt/minion\n",
				"service salt-minion restart\n"
              ]
            ]
          }
        }
      }
    }
  }
}